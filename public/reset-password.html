<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Reset Password — Orbital</title>
<meta name="theme-color" content="#05060A">
<link rel="icon" href="/favicon.ico">
<!-- Supabase config: replace content values at deploy time -->
<meta name="supabase-url" content="SUPABASE_URL_PLACEHOLDER">
<meta name="supabase-anon-key" content="SUPABASE_ANON_KEY_PLACEHOLDER">
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  body{
    background:#05060A;
    color:rgba(255,255,255,0.85);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    line-height:1.6;
    -webkit-font-smoothing:antialiased;
    min-height:100vh;
    display:flex;align-items:center;justify-content:center;
  }
  .card{
    text-align:center;
    max-width:420px;
    width:100%;
    padding:48px 32px;
  }
  .icon{
    width:64px;height:64px;border-radius:14px;
    margin:0 auto 32px;
    box-shadow:0 0 60px rgba(0,215,255,0.15);
  }
  h1{
    font-size:24px;font-weight:700;color:#fff;
    margin-bottom:8px;letter-spacing:-0.3px;
  }
  .subtitle{
    font-size:15px;color:rgba(255,255,255,0.5);
    margin-bottom:28px;line-height:1.55;
  }
  .form-group{margin-bottom:16px;text-align:left}
  label{display:block;font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:6px}
  input[type="password"]{
    width:100%;
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.11);
    border-radius:10px;
    color:#fff;
    font-size:16px;
    padding:14px 16px;
    outline:none;
    transition:border-color 0.2s;
  }
  input[type="password"]:focus{border-color:rgba(0,215,255,0.4)}
  .submit-btn{
    display:block;width:100%;
    background:#00D7FF;color:#05060A;
    border:none;border-radius:10px;padding:14px;
    font-size:16px;font-weight:600;
    cursor:pointer;transition:background 0.2s;
    margin-top:8px;
  }
  .submit-btn:hover{background:#33dfff}
  .submit-btn:disabled{opacity:0.5;cursor:not-allowed}
  .message{
    margin-top:16px;
    padding:12px 16px;
    border-radius:10px;
    font-size:14px;
    line-height:1.5;
  }
  .message.error{background:rgba(255,82,82,0.10);border:1px solid rgba(255,82,82,0.30);color:#FF5252}
  .message.success{background:rgba(0,229,255,0.08);border:1px solid rgba(0,229,255,0.28);color:#00E5FF}
  .strength{font-size:12px;color:rgba(255,255,255,0.4);margin-top:6px}
  .home-link{
    display:inline-block;margin-top:24px;
    color:rgba(255,255,255,0.4);font-size:14px;
    text-decoration:none;
  }
  .home-link:hover{color:rgba(255,255,255,0.6)}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="card">
    <img src="/icon.png" alt="Orbital" class="icon" width="64" height="64">
    <h1>Reset Your Password</h1>
    <p class="subtitle">Enter a new password for your Orbital account.</p>

    <!-- Loading state while session initializes -->
    <div id="loading">
      <p class="subtitle">Verifying your reset link...</p>
    </div>

    <!-- Error state if token is invalid -->
    <div id="token-error" class="hidden">
      <div class="message error">This reset link is invalid or has expired. Please request a new one from the app.</div>
      <a href="/" class="home-link">Back to Orbital</a>
    </div>

    <!-- Password form -->
    <form id="reset-form" class="hidden" autocomplete="off">
      <div class="form-group">
        <label for="password">New password</label>
        <input type="password" id="password" name="password" autocomplete="new-password" placeholder="At least 8 characters" required>
        <div id="strength" class="strength"></div>
      </div>
      <div class="form-group">
        <label for="confirm">Confirm password</label>
        <input type="password" id="confirm" name="confirm" autocomplete="new-password" placeholder="Re-enter password" required>
      </div>
      <button type="submit" class="submit-btn" id="submit-btn">Update Password</button>
      <div id="form-message" class="hidden"></div>
    </form>

    <!-- Success state -->
    <div id="success" class="hidden">
      <div class="message success">Password updated! You can now sign in with your new password in the app.</div>
      <a href="/" class="home-link">Back to Orbital</a>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
(function() {
  // These values are injected at deploy time or read from meta tags
  var SUPABASE_URL = document.querySelector('meta[name="supabase-url"]')?.content || 'https://tenfwzjccqfecctxdbpi.supabase.co';
  var SUPABASE_ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]')?.content || '';

  var client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  var $loading = document.getElementById('loading');
  var $tokenError = document.getElementById('token-error');
  var $form = document.getElementById('reset-form');
  var $success = document.getElementById('success');
  var $password = document.getElementById('password');
  var $confirm = document.getElementById('confirm');
  var $submitBtn = document.getElementById('submit-btn');
  var $formMessage = document.getElementById('form-message');
  var $strength = document.getElementById('strength');

  function show(el) { el.classList.remove('hidden'); }
  function hide(el) { el.classList.add('hidden'); }

  // Password strength check
  function checkStrength(pw) {
    if (pw.length < 8) return { ok: false, label: 'Too short (min 8 characters)' };
    var score = 0;
    if (/[a-z]/.test(pw)) score++;
    if (/[A-Z]/.test(pw)) score++;
    if (/[0-9]/.test(pw)) score++;
    if (/[^a-zA-Z0-9]/.test(pw)) score++;
    if (pw.length >= 12) score++;
    if (score <= 2) return { ok: true, label: 'Weak' };
    if (score <= 3) return { ok: true, label: 'Fair' };
    return { ok: true, label: 'Strong' };
  }

  $password.addEventListener('input', function() {
    var s = checkStrength($password.value);
    $strength.textContent = $password.value ? 'Strength: ' + s.label : '';
  });

  // Initialize — Supabase reads the hash fragment automatically
  client.auth.onAuthStateChange(function(event, session) {
    if (event === 'PASSWORD_RECOVERY' && session) {
      hide($loading);
      show($form);
    } else if (event === 'SIGNED_IN' && session) {
      // Recovery token was valid, session established
      hide($loading);
      show($form);
    }
  });

  // Fallback: if no auth event fires within 5 seconds, show error
  setTimeout(function() {
    if (!$form.classList.contains('hidden') || !$success.classList.contains('hidden')) return;
    hide($loading);
    show($tokenError);
  }, 5000);

  // Form submission
  $form.addEventListener('submit', async function(e) {
    e.preventDefault();
    hide($formMessage);

    var pw = $password.value;
    var confirmPw = $confirm.value;

    if (pw.length < 8) {
      showFormError('Password must be at least 8 characters.');
      return;
    }
    if (pw !== confirmPw) {
      showFormError('Passwords do not match.');
      return;
    }

    $submitBtn.disabled = true;
    $submitBtn.textContent = 'Updating...';

    try {
      var result = await client.auth.updateUser({ password: pw });
      if (result.error) {
        showFormError(result.error.message);
        $submitBtn.disabled = false;
        $submitBtn.textContent = 'Update Password';
        return;
      }
      hide($form);
      show($success);
    } catch (err) {
      showFormError('Something went wrong. Please try again.');
      $submitBtn.disabled = false;
      $submitBtn.textContent = 'Update Password';
    }
  });

  function showFormError(msg) {
    $formMessage.className = 'message error';
    $formMessage.textContent = msg;
    show($formMessage);
  }
})();
</script>
</body>
</html>
